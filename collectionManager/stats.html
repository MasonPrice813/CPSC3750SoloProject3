<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Book Collection Stats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header>
  <h1>Collection Statistics</h1>
  <nav>
    <a href="index.html"><button type="button" class="secondary">Back</button></a>
  </nav>
</header>

<main>
  <section class="statsGrid" id="stats"></section>
  <section class="card" id="byCat"></section>
</main>

<script>
function getCookie(name) {
  const parts = document.cookie.split(";").map(s => s.trim());
  for (const p of parts) {
    if (p.startsWith(name + "=")) return decodeURIComponent(p.substring(name.length + 1));
  }
  return "";
}

const pageSize = Number(getCookie("pageSize")) || 10;

fetch(`/api/stats?pageSize=${pageSize}`)
  .then(res => res.json())
  .then(data => {
    document.getElementById("stats").innerHTML = `
      <div class="statCard">
        <h2>Total Records</h2>
        <p>${data.total}</p>
      </div>
      <div class="statCard">
        <h2>Current Page Size</h2>
        <p>${data.pageSize}</p>
      </div>
      <div class="statCard">
        <h2>Average Publication Year</h2>
        <p>${data.averagePublicationYear}</p>
      </div>
      <div class="statCard">
        <h2>Average Rating</h2>
        <p>${data.averageRating}</p>
      </div>
      <div class="statCard">
        <h2>Total Collection Value</h2>
        <p>$${Number(data.totalValue).toFixed(2)}</p>
      </div>
    `;

    const byCat = data.countByCategory || {};
    const rows = Object.keys(byCat)
      .sort()
      .map(k => `<tr><td>${k}</td><td>${byCat[k]}</td></tr>`)
      .join("");

    document.getElementById("byCat").innerHTML = `
      <h2 style="margin-top:0;">Count by Category</h2>
      <table>
        <tr><th>Category</th><th>Count</th></tr>
        ${rows || "<tr><td colspan='2'>No data</td></tr>"}
      </table>
    `;
  })
  .catch(() => {
    document.getElementById("stats").innerHTML = `
      <div class="card">
        <h2>Could not load stats</h2>
        <p>Try refreshing the page.</p>
      </div>
    `;
  });
</script>

</body>
</html>
